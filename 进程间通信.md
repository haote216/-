#### 进程间通信

进程间通信的本质是让俩个不同的进程看到一份公共的资源。

###### 目的：

数据传输：一个进程需要将它的数据发送给另一个进程。

资源共享：多个进程之间共享同样的资源。

通知事件：一个进程需要向另一个或一组进程发送消息，通知它发生了某种事件（如进程终止时要通知父进程）

进程控制：有些进程希望完全控制另一个进程的所有陷入和异常，并能够及时知道它的状态改变。

##### 进程间通信分类：

管道：匿名管道pipe、命名管道

System V IPC： System V消息队列、System V共享内存、System V信号量

POSIX IPC：消息队列、共享内存、信号量、互斥量、条件变量、读写锁

###### 匿名管道

```
#include<unistd.h>
功能：创建无名管道
int pipe(int fd[2]);
fd:文件描述符组，其中fd[0]表示读端，fd[1]表示写端
返回值：成功返回0，失败返回错误代码
```

特点：

1.只能用于具有共同祖先的进程（具有亲缘关系的进程）之间通信；通常，一个管道由一个进程创建，然后该进程调用fork，此后父子之间就可以应用该管道。

2.管道提供流式服务（管道是面向字节流的）

3.进程退出，管道释放，所以管道的生命周期随进程。

4.内核会对管道操作进行同步和互斥。同步、互斥：

5.管道只能一个方向流动，需要双方通信时，需要建立起两个管道。

管道读写规则：

谁快谁等待，管道有同步机制。

四种情况：

1）写端不写，并且把写端的文件描述符关了。    //父进程一直读到文件结尾。

2）写端不写，也没有关闭文件描述符。                //父进程一直在等待。

3）写端一直在写，读端不读，并且把读端的文件描述符关了。        //操作系统会向写端发送SIGPIPE信号。

4）写端一直在写，读端不关闭文件描述符，但是也不读。               //一直写会把管道写满，然后子进程一直等待。

###### 命名管道

```
int mkfifo(const char *filename, mode_t mode);
```

匿名管道和命名管道的区别：

1.匿名管道由pipe函数创建并打卡；

2.命名管道由mkfifo函数创建，打开用open

pipe与FIFO之间唯一的区别在于它们创建和打开的方式不同，一旦这些工作完成之后，它们具有相同的语义。

|管道一定采用匿名管道。

##### 消息队列

ipcs -q：查看ipc资源消息队列

ipcrm -q msqid：删除消息队列

消息队列提供了一个从一个进程向另外一个进程发送一块数据的方法。

消息队列的生命周期不随进程，ipc资源的生命周期随内核。

```
int msgget(key_t key, int msgflg);
O_CREAT | O_EXCL：想创建的消息队列已经有了，则创建消息队列的函数出错返回。
O_CREAT：如果没有这个消息队列，创建这个消息队列。如果有这个消息队列，就把这个消息队列打开。
成功返回标识符，出错返回-1
```

```
int msgctl(int msqid ,int cmd ,struct msqid_ds *buf)
```

```
msgsnd
```

```
msgrcv
```

##### 共享内存

共享内存的生命周期随内核

ipcs -m：查看共享内存

ipcrm -m shmid：删除shmid序列号的共享内存

```
shmget：创建共享内存
int shmget(key_t key,size_t size,int shmflg);
参数：
	key：这个共享内存段名字
	size：共享内存大小
	shmfig：由九个权限标志构成，它们的用法和创建文件时使用的mode模式标志是一样的
返回值：成功返回一个非负整数，即该共享内存的标识码；失败返回-1
```

```
shmat:将共享内存段链接到进程地址空间
void *shmat(int shmid,const void *shmaddr,int shmflg)
参数：
	shmid：共享内存标识
	shmaddr：指定连接的地址
	shmflg：它的两个可能取值是SHM_RND和SHM_RDONLY
返回值：成功返回一个指针，指向共享内存第一个节；失败返回-1
```

```
shmdt：将共享内存段与当前进程脱离
int shmdt(const void *shmaddr)
参数：
	shmaddr：由shmat所返回的指针
返回值：成功返回0；失败返回-1
注意：将共享内存段与当前进程脱离不等于删除共享内存段
```

```
shmctl：控制共享内存
int shmctl(int shmid,int cmd,struct shmid_ds * buf)
参数：
	shmid：由shmget返回的共享内存标识码
	cmd：将要采取的动作（有三个可取值）
	buf：指向一个保存着共享内存的模式状态和访问权限的数据结构
返回值：成功返回0；失败返回-1
```

##### 信号量

ipcs -s：

ipcrm -s ：

两个进程看到的同一份公共资源称为临界资源。

各个进程中访问临界资源的代码段叫做临界区。

由于各进程要求共享资源，而且有些资源需要互斥使用，因此各进程间竞争使用这些资源，进程的这种关系叫做进程的互斥。

在互斥的基础上，让访问具有一定的顺序，进而保障公平性，称为同步。

原子性：指程序的操作要么全部完成，要么全部不完成



信号量本质上是一个计数器，也是临界资源。

P操作是计数器--，V操作是计数器++。

信号量的++ --是原子的。

二元信号量本质上是一把互斥锁，称为挂起等待锁。



作业：模拟myshell支持重定向支持管道

